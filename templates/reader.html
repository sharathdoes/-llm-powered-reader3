<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.metadata.title }}</title>

    <style>
        body { 
            margin: 0; 
            padding: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #ffffff;
        }

        /* Sidebar */
        #sidebar { 
            width: 300px; 
            background: #f8f9fa; 
            border-right: 1px solid #e9ecef; 
            overflow-y: auto; 
            padding: 20px; 
            flex-shrink: 0; 
        }

        .nav-header { 
            font-weight: 600; 
            color: #444; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #dee2e6; 
        }

        .nav-home { 
            display: block; 
            margin-bottom: 20px; 
            color: #007aff; 
            text-decoration: none; 
            font-size: 0.9em; 
        }

        ul.toc-list { list-style: none; padding-left: 0; margin: 0; }
        ul.toc-list ul { padding-left: 20px; }
        li.toc-item { margin-bottom: 8px; }
        a.toc-link { 
            color: #444; 
            text-decoration: none; 
            padding: 4px 0; 
            display: block; 
        }
        a.toc-link:hover { color: #000; }
        a.toc-link.active { color: #ff2d55; font-weight: 600; }

        /* Main content */
        #main { flex-grow: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .content-container { 
            max-width: 700px; 
            margin: 0 auto; 
            padding: 60px 40px; 
            line-height: 1.7; 
            font-size: 1.12em; 
            color: #222; 
        }

        .book-content img { max-width: 100%; margin: 20px auto; display: block; }
        .book-content h1, .book-content h2, .book-content h3 { 
            margin-top: 1.5em; 
            color: #333; 
        }

        .book-content p { margin-bottom: 1.5em; text-align: justify; }

        .chapter-nav { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 60px; 
            padding-top: 20px; 
            border-top: 1px solid #eee; 
        }

        .nav-btn { 
            color: #007aff; 
            text-decoration: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            border: 1px solid #007aff; 
            transition: 0.2s; 
            font-weight: 500;
        }

        .nav-btn:hover { background: #007aff; color: white; }
        .nav-btn.disabled { opacity: 0.4; pointer-events: none; }

        /* ---------- Apple Minimal Chat Box ---------- */
        #chatbox {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: #ffffffee;
            backdrop-filter: saturate(180%) blur(20px);
            border: 1px solid #e5e5e5;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        #chat-header {
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 600;
            color: #111;
            border-bottom: 1px solid #eaeaea;
        }

        #messages {
            height: 230px;
            overflow-y: auto;
            padding: 12px;
            font-size: 14px;
            color: #222;
        }

        .bubble-user {
            background: #007aff;
            color: white;
            padding: 8px 12px;
            border-radius: 14px;
            margin: 8px 0;
            max-width: 80%;
            margin-left: auto;
            display: inline-block;
        }

        .bubble-bot {
            background: #f2f2f7;
            color: #333;
            padding: 8px 12px;
            border-radius: 14px;
            margin: 8px 0;
            max-width: 80%;
            display: inline-block;
        }

        #chat-input-area {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-top: 1px solid #eaeaea;
            background: white;
        }

        #chatInput {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        #sendBtn {
            padding: 10px 14px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        #sendBtn:hover { background: #0063d6; }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <a href="/" class="nav-home">← Back to Library</a>
        <div class="nav-header">{{ book.metadata.title }}</div>

        {% macro render_toc(items) %}
        <ul class="toc-list">
            {% for item in items %}
            <li class="toc-item">
                {% set is_active = current_chapter.href == item.file_href %}

                <a href="#" onclick="findAndGo('{{ item.file_href }}')" 
                   class="toc-link {% if is_active %}active{% endif %}">
                    {{ item.title }}
                </a>

                {% if item.children %}
                {{ render_toc(item.children) }}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% endmacro %}

        {{ render_toc(book.toc) }}
    </div>

    <!-- MAIN -->
    <div id="main">
        <div class="content-container">
            <div class="book-content">
                {{ current_chapter.content | safe }}
            </div>

            <div class="chapter-nav">
                {% if prev_idx is not none %}
                <a href="/read/{{ book_id }}/{{ prev_idx }}" class="nav-btn">← Previous</a>
                {% else %}
                <span class="nav-btn disabled">← Previous</span>
                {% endif %}

                <span style="color: #888;">Section {{ chapter_index + 1 }} of {{ book.spine|length }}</span>

                {% if next_idx is not none %}
                <a href="/read/{{ book_id }}/{{ next_idx }}" class="nav-btn">Next →</a>
                {% else %}
                <span class="nav-btn disabled">Next →</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- CHATBOX -->
    <div id="chatbox">
        <div id="chat-header">Chat with Groq</div>

        <div id="messages"></div>

        <div id="chat-input-area">
            <input id="chatInput" placeholder="Message…" />
            <button id="sendBtn" onclick="sendMessage()">➤</button>
        </div>
    </div>

    <script>
        async function sendMessage() {
            const input = document.getElementById("chatInput");
            const text = input.value.trim();
            if (!text) return;

            const messages = document.getElementById("messages");

            // User bubble
            const userBubble = document.createElement("div");
            userBubble.className = "bubble-user";
            userBubble.textContent = text;
            messages.appendChild(userBubble);

            messages.scrollTop = messages.scrollHeight;

            input.value = "";

            // Fetch stream
            const response = await fetch("/chat-stream", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: text })
            });

            const botBubble = document.createElement("div");
            botBubble.className = "bubble-bot";
            messages.appendChild(botBubble);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                botBubble.textContent += decoder.decode(value);
                messages.scrollTop = messages.scrollHeight;
            }
        }

        document.getElementById("chatInput").addEventListener("keydown", e => {
            if (e.key === "Enter") sendMessage();
        });

        /* TOC Mapping */
        const spineMap = {
            {% for ch in book.spine %}
            "{{ ch.href }}": {{ ch.order }},
            {% endfor %}
        };

        function findAndGo(filename) {
            const clean = filename.split("#")[0];
            const idx = spineMap[clean];
            if (idx !== undefined) {
                window.location.href = "/read/{{ book_id }}/" + idx;
            }
        }
    </script>

</body>
</html>
